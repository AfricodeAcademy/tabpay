{% extends 'base.html' %} {% import 'flash.html' as flash %} {% block heading%}
Regular Block Hosting {% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
/>
<!-- Dashboard Content -->
<div class="dashboard">
  <div class="container">
    <p class="host">
      A cornerstone of community engagement, regular block meetings are held
      weekly at the designated host's homestead, where members commit to
      contributing a pre-agreed amount, fostering a culture of mutual support
      and collective progress.
    </p>

    <div class="dashboard-content">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs p-3">
        <li class="nav-item">
          <a
            class="nav-link {% if active_tab == 'schedule_meeting' %}active{% endif %}"
            href="{{ url_for('main.host', active_tab='schedule_meeting') }}"
            >Schedule Weekly Block Meeting</a
          >
        </li>

        <li class="nav-item">
          <a
            class="nav-link {% if active_tab == 'upcoming_block' %}active{% endif %}"
            href="{{ url_for('main.host', active_tab='upcoming_block') }}"
            >Upcoming Block</a
          >
        </li>

        <li class="nav-item">
          <a
            class="nav-link {% if active_tab == 'block_members' %}active{% endif %}"
            href="{{ url_for('main.host', active_tab='block_members') }}"
            >Block Members</a
          >
        </li>
      </ul>

      <!-- Tab Panes -->
      <div class="tab-content">
        <!-- Schedule Weekly Block Meeting -->
        <div
          id="schedule_meeting"
          class="tab-pane fade {% if active_tab == 'schedule_meeting' %}show active{% endif %}"
        >
          <p class="text-center mb-2 p-3 fs-4">
            Schedule the Weekly Block Meeting
          </p>
          <form
            method="POST"
            action="{{ url_for('main.host', active_tab='schedule_meeting') }}"
            novalidate
          >
            {{ schedule_form.hidden_tag() }}

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ schedule_form.block.label }} {{
                  schedule_form.block(class="select", id="block") }} {% if
                  schedule_form.block.errors %}
                  <div class="text-danger">
                    {% for error in schedule_form.block.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>

              <div class="col-md-6">
                <div class="mb-3">
                  {{ schedule_form.zone.label }} {{
                  schedule_form.zone(class="select", id="zone") }} {% if
                  schedule_form.zone.errors %}
                  <div class="text-danger">
                    {% for error in schedule_form.zone.errors %}
                    <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                {{ schedule_form.member.label }} {{
                schedule_form.member(class="select", id="member") }} {% if
                schedule_form.member.errors %}
                <div class="text-danger">
                  {% for error in schedule_form.member.errors %}
                  <small>{{ error }}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <style>
                .input-with-icon {
                  position: relative;
                }

                .input-with-icon i {
                  position: absolute;
                  left: 10px;
                  top: 40%;
                  transform: translateY(-50%);
                  color: #2cde10;
                  pointer-events: none;
                }

                .input {
                  padding-left: 30px;
                }
              </style>
              <div class="col-md-6">
                {{ schedule_form.date.label }}
                <div class="input-with-icon">
                  <i class="fas fa-calendar-alt"></i>
                  {{ schedule_form.date(class="input", placeholder="YYYY-MM-DD
                  HH:MM:SS", id="date") }}
                </div>
                {% if schedule_form.date.errors %}
                <div class="text-danger">
                  {% for error in schedule_form.date.errors %}
                  <small>{{ error }}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <button type="submit" name="schedule_submit" class="submit-btn">
              {{ schedule_form.submit.label.text }}
            </button>
            {{ flash.render_flash_messages() }}
          </form>
        </div>

        <!--/ Schedule Weekly Block Meeting -->

        <!-- Upcoming Block -->
        <div
          id="upcoming_block"
          class="tab-pane fade {% if active_tab == 'upcoming_block' %}show active{% endif %}"
        >
          <h5 class="text-center mt-2 mb-1">Upcoming Block</h5>

          <div class="row pb-2 pt-1 ms-2">
            <!-- Block Details Section -->
            <div class="col-md-6">
              <form
                method="GET"
                action="{{ url_for('main.host', active_tab='upcoming_block') }}"
              >
                <div class="card p-4">
                  <h6 class="mb-4">Block Details</h6>
                  <p><strong>Block Name:</strong> {{meeting_block}}</p>
                  <p><strong>Zone Name:</strong> {{meeting_zone}}</p>
                  <p><strong>The Host:</strong> {{host}}</p>
                  <p><strong>When:</strong> {{when}}</p>
                  <p>
                    Wrong meeting details?
                    <button
                      type="button"
                      class="btn btn-sm btn-warning"
                      data-bs-toggle="modal"
                      data-bs-target="#editMeetingModal{{id_meeting }}"
                    >
                      Edit
                    </button>
                  </p>

                  <!-- Edit Meeting Modal -->
                  <div
                    class="modal fade"
                    id="editMeetingModal{{id_meeting }}"
                    tabindex="-1"
                    role="dialog"
                    aria-labelledby="editMeetingModalLabel{{id_meeting }}"
                    aria-hidden="true"
                  >
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form
                          method="post"
                          action="{{ url_for('main.host', meeting_id=id_meeting,active_tab='upcoming_block') }}"
                          novalidate
                        >
                          <div class="modal-header">
                            <h5
                              class="modal-title"
                              id="editMeetingModalLabel{{id_meeting }}"
                            >
                              Edit Meeting Details
                            </h5>
                            <button
                              type="button"
                              class="close"
                              data-bs-dismiss="modal"
                              aria-label="Close"
                            >
                              <span aria-hidden="true">&times;</span>
                            </button>
                          </div>
                          {{ flash.render_flash_messages() }}

                          <div class="modal-body">
                            {{ schedule_form.hidden_tag() }}
                            <input
                              type="hidden"
                              name="meeting_id"
                              value="{{ id_meeting }}"
                            />
                            <!-- <input type="text" name="host" value="{{ host }}" /> -->
                            <!-- <input
                              type="text"
                              name="meeting_block"
                              value="{{ meeting_block }}"
                            />
                            <input
                              type="text"
                              name="meeting_zone"
                              value="{{ meeting_zone }}"
                            />
                            <input type="text" name="when" value="{{ when }}" /> -->

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  {{ schedule_form.block.label }} {{
                                  schedule_form.block(class="select",
                                  id="block") }} {% if
                                  schedule_form.block.errors %}
                                  <div class="text-danger">
                                    {% for error in schedule_form.block.errors
                                    %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                  </div>
                                  {% endif %}
                                </div>
                              </div>

                              <div class="col-md-6">
                                <div class="mb-3">
                                  {{ schedule_form.zone.label }} {{
                                  schedule_form.zone(class="select", id="zone")
                                  }} {% if schedule_form.zone.errors %}
                                  <div class="text-danger">
                                    {% for error in schedule_form.zone.errors %}
                                    <small>{{ error }}</small>
                                    {% endfor %}
                                  </div>
                                  {% endif %}
                                </div>
                              </div>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                {{ schedule_form.member.label }} {{
                                schedule_form.member(class="select",
                                id="member") }} {% if
                                schedule_form.member.errors %}
                                <div class="text-danger">
                                  {% for error in schedule_form.member.errors %}
                                  <small>{{ error }}</small>
                                  {% endfor %}
                                </div>
                                {% endif %}
                              </div>

                              <div class="col-md-6">
                                {{ schedule_form.date.label }}
                                <div class="input-with-icon">
                                  <i class="fas fa-calendar-alt"></i>
                                  {{ schedule_form.date(class="input",
                                  placeholder="YYYY-MM-DD HH:MM:SS", id="date")
                                  }}
                                </div>
                                {% if schedule_form.date.errors %}
                                <div class="text-danger">
                                  {% for error in schedule_form.date.errors %}
                                  <small>{{ error }}</small>
                                  {% endfor %}
                                </div>
                                {% endif %}
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-dismiss="modal"
                            >
                              Cancel
                            </button>
                            <button
                              type="submit"
                              name="edit_meeting"
                              class="btn btn-success"
                            >
                              Save Changes
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <button
                    type="button"
                    class="payment-link-btn"
                    onclick="generatePaymentLink()"
                  >
                    GENERATE PAYMENT LINK
                  </button>
                  <div class="payment-link-container" id="paymentLinkContainer">
                    <span class="payment-text" id="paymentLinkText"
                      >{{ paymentlink }}</span
                    >
                    <button class="copy-button" onclick="copyToClipboard()">
                      COPY
                    </button>
                  </div>
                </div>
              </form>
            </div>
            <!-- Communicate & Send Payment Link Section -->
            <div class="col-md-6">
              <form
                method="POST"
                action="{{ url_for('main.host', active_tab='upcoming_block') }}"
              >
                <input
                  type="hidden"
                  name="csrf_token"
                  value="{{ csrf_token() }}"
                />
                <div class="card p-4">
                  <h6 class="no-wrap mb-5">Communicate & Send Payment Link</h6>
                  <label for="message">Message:</label>
                  <textarea
                    id="message"
                    class="form-control mt-4"
                    rows="6"
                    style="height: 150px"
                    readonly
                  >
{{ message }}</textarea
                  >
                  <input type="hidden" name="message" value="{{ message }}" />

                  <button class="submit-btn" name="send_sms" type="submit">
                    SEND
                  </button>
                  {{ flash.render_flash_messages() }}
                </div>
              </form>
            </div>
          </div>
        </div>
        <!--/ Upcoming Block -->

        <!-- Block Members -->
        <div
          id="block_members"
          class="tab-pane fade {% if active_tab == 'block_members' %}show active{% endif %} ps-4 pb-2"
        >
          <h4
            style="
              font-weight: 500;
              color: rgb(0, 0, 0);
              letter-spacing: 2px;
              text-decoration: underline;
              font-size: large;
            "
          >
            Filter By:
          </h4>

          <div class="flex-container mt-4">
            <div class="row">
              <div class="col-md-3" style="max-width: fit-content">
                {{ schedule_form.block.label }} {{
                schedule_form.block(class="select member-tab-block", id="block") }}
              </div>
              <div class="col-md-3" style="max-width: fit-content">
                {{ schedule_form.zone.label }} {{
                schedule_form.zone(class="select member-tab-zone", id="zone") }}
              </div>
            </div>
          </div>

          <table class="table table-responsive text-center" id="membersTable">
            <thead>
              <tr>
                <th>Full Names</th>
                <th>Phone Number</th>
                <th>ID Number</th>
                <th>Membership</th>
                <th>Bank</th>
                <th>A/C Number</th>
                <th>Edit</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody>
              {% for member in members %}
              <tr>
                <td>{{ member.full_name }}</td>
                <td>{{ member.phone_number }}</td>
                <td>{{ member.id_number }}</td>
                <td>
                  {% for i in range(member.block_memberships | length) %} {{
                  member.block_memberships[i]['name'] }} ({{
                  member.zone_memberships[i]['name'] }}) {% if i + 1 <
                  member.block_memberships | length %}
                  <br />
                  {% endif %} {% endfor %}
                </td>

                <td>{{ member.bank_name }}</td>
                <td>{{ member.acc_number }}</td>

                <td>
                  <button
                    class="btn"
                    style="
                      color: green;
                      background-color: white;
                      font-size: 25px;
                      padding: 0;
                      margin: 0;
                    "
                    data-bs-toggle="modal"
                    data-bs-target="#editModal{{ member.id }}"
                  >
                    <i class="bi bi-pencil-square"></i>
                  </button>
                </td>
                <td>
                  <button
                    class="btn"
                    style="
                      color: white;
                      background-color: rgb(200, 26, 26);
                      border-radius: 20px;
                    "
                    data-bs-toggle="modal"
                    data-bs-target="#removeModal{{ member.id }}"
                  >
                    <i class="bi bi-trash3-fill"></i>
                  </button>
                </td>
              </tr>

              <!-- Edit Member Modal -->
              <div
                class="modal fade"
                id="editModal{{ member.id }}"
                tabindex="-1"
                aria-labelledby="editModalLabel{{ member.id }}"
                aria-hidden="true"
              >
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5
                        class="modal-title"
                        style="color: #4c9323"
                        id="editModalLabel{{ member.id }}"
                      >
                        Edit Member
                      </h5>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>
                    {{ flash.render_flash_messages() }}

                    <div class="modal-body">
                      <form
                        id="editForm{{ member.id }}"
                        method="post"
                        action="{{ url_for('main.host', user_id=member.id,active_tab='block_members') }}"
                        novalidate
                      >
                        {{ update_form.hidden_tag() }}

                        <div class="mb-3">
                          {{
                          update_form.full_name.label(class="update_form-label")
                          }} {{
                          update_form.full_name(class="update_form-control",
                          value=member.full_name) }} {% if
                          update_form.full_name.errors %}
                          <div class="text-danger">
                            {{ update_form.full_name.errors[0] }}
                          </div>
                          {% endif %}
                        </div>
                        <div class="mb-3">
                          {{
                          update_form.phone_number.label(class="update_form-label")
                          }} {{
                          update_form.phone_number(class="update_form-control",
                          value=member.phone_number) }} {% if
                          update_form.phone_number.errors %}
                          <div class="text-danger">
                            {{ update_form.phone_number.errors[0] }}
                          </div>
                          {% endif %}
                        </div>
                        <div class="mb-3">
                          {{
                          update_form.id_number.label(class="update_form-label")
                          }} {{
                          update_form.id_number(class="update_form-control",
                          value=member.id_number) }}
                        </div>
                        <div class="mb-3">
                          {{
                          update_form.block_id.label(class="update_form-label")
                          }} {{ update_form.block_id(class="form-select",
                          value=member.block_memberships[0]['name']) }}
                        </div>
                        <div class="mb-3">
                          {{
                          update_form.member_zone.label(class="update_form-label")
                          }} {{ update_form.member_zone(class="form-select",
                          value=member.zone_memberships[0]['name']) }}
                        </div>

                        <div class="mb-3">
                          {{
                          update_form.bank_id.label(class="update_form-label")
                          }} {{ update_form.bank_id(class="form-select",
                          value=member.bank_name) }}
                        </div>
                        <div class="mb-3">
                          {{
                          update_form.account_number.label(class="update_form-label")
                          }} {{
                          update_form.account_number(class="update_form-control",
                          value=member.acc_number) }}
                        </div>

                        <button
                          type="submit"
                          class="submit-btn"
                          name="edit_member_submit"
                        >
                          Save Changes
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Remove Member Modal -->
              <div
                class="modal fade"
                id="removeModal{{ member.id }}"
                tabindex="-1"
                aria-labelledby="removeModalLabel{{ member.id }}"
                aria-hidden="true"
              >
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5
                        class="modal-title"
                        style="color: #4c9323"
                        id="removeModalLabel{{ member.id }}"
                      >
                        Remove Member
                      </h5>
                      <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                      ></button>
                    </div>
                    {{ flash.render_flash_messages() }}

                    <div class="modal-body">
                      Are you sure you want to remove {{ member.full_name }}?
                    </div>
                    <div class="modal-footer">
                      <form
                        id="removeForm{{ member.id }}"
                        method="post"
                        action="{{ url_for('main.host', user_id=member.id) }}"
                      >
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Cancel
                        </button>
                        <input type="hidden" name="_method" value="DELETE" />

                        <input
                          type="hidden"
                          name="csrf_token"
                          value="{{ csrf_token() }}"
                        />

                        <button
                          type="submit"
                          class="btn btn-danger"
                          name="remove_member_submit"
                        >
                          Remove
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!--/ Block Members -->
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- For Cascade dropdown - AJAX -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize flatpickr for date input
    flatpickr("#date", {
      enableTime: true,
      dateFormat: "Y-m-d H:i:S",
      minDate: "today",
    });

    // Get the dropdown elements
    const blockSelect = document.getElementById("block");
    const zoneSelect = document.getElementById("zone");
    const memberSelect = document.getElementById("member");

    // Function to reset options of a select element
    function resetSelect(select, defaultText = "Choose an option") {
      select.innerHTML = `<option value="">${defaultText}</option>`;
      select.disabled = true;
    }

    // Function to populate a select element with options
    function populateSelect(select, data, defaultText) {
      select.innerHTML = `<option value="">${defaultText}</option>`;
      data.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
      });
      select.disabled = false;
    }

    // Handle block selection
    blockSelect.addEventListener("change", function () {
      const blockId = this.value;
      resetSelect(zoneSelect, "Choose a Zone");
      resetSelect(memberSelect, "Choose a Member");

      if (blockId) {
        fetch(`/get_zones/${blockId}`)
          .then((response) => response.json())
          .then((data) => {
            populateSelect(zoneSelect, data, "Choose a Zone");
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error fetching zones. Please try again.");
          });
      }
    });

    // Handle zone selection
    zoneSelect.addEventListener("change", function () {
      const zoneId = this.value;
      resetSelect(memberSelect, "Choose a Member");

      if (zoneId) {
        fetch(`/get_members/${zoneId}`)
          .then((response) => response.json())
          .then((data) => {
            populateSelect(memberSelect, data, "Choose a Member");
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error fetching members. Please try again.");
          });
      }
    });

    // Initially disable zone and member selects
    resetSelect(zoneSelect, "Choose a Zone");
    resetSelect(memberSelect, "Choose a Member");
  });
</script>
<!-- END For Cascade dropdown - AJAX -->

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    flatpickr("input[name='date']", {
      enableTime: true,
      dateFormat: "Y-m-d H:i:S",
    });
  });
</script>

<!-- For Member Tab Cascade Dropdowns -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const memberTabBlockSelects = document.querySelectorAll('.member-tab-block');
    const memberTabZoneSelects = document.querySelectorAll('.member-tab-zone');
    const membersTable = document.getElementById('membersTable');

    function resetMemberTabSelect(select, defaultText = "Choose an option") {
      select.innerHTML = `<option value="">${defaultText}</option>`;
      select.disabled = true;
    }

    function populateMemberTabSelect(select, data, defaultText) {
      select.innerHTML = `<option value="">${defaultText}</option>`;
      data.forEach((item) => {
        const option = document.createElement("option");
        option.value = item.id;
        option.textContent = item.name;
        select.appendChild(option);
      });
      select.disabled = false;
    }

    function updateMembersTable(blockId, zoneId) {
      const tbody = membersTable.querySelector('tbody');
      const url = zoneId 
        ? `/get_filtered_members/${blockId}/${zoneId}`
        : `/get_filtered_members/${blockId}`;

      fetch(url)
        .then(response => response.json())
        .then(members => {
          tbody.innerHTML = '';
          members.forEach(member => {
            const row = `
              <tr>
                <td>${member.full_name}</td>
                <td>${member.phone_number}</td>
                <td>${member.id_number}</td>
                <td>${member.membership_info}</td>
                <td>${member.bank_name}</td>
                <td>${member.acc_number}</td>
                <td>
                  <button class="btn" style="color: green; background-color: white; font-size: 25px; padding: 0; margin: 0;"
                    data-bs-toggle="modal" data-bs-target="#editModal${member.id}">
                    <i class="bi bi-pencil-square"></i>
                  </button>
                </td>
                <td>
                  <button class="btn" style="color: white; background-color: rgb(200, 26, 26); border-radius: 20px;"
                    data-bs-toggle="modal" data-bs-target="#removeModal${member.id}">
                    <i class="bi bi-trash3-fill"></i>
                  </button>
                </td>
              </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        })
        .catch(error => {
          console.error("Error fetching members:", error);
          alert("Error fetching members. Please try again.");
        });
    }

    // Handle block selection for each block select in member tab
    memberTabBlockSelects.forEach((blockSelect, index) => {
      const correspondingZoneSelect = memberTabZoneSelects[index];
      
      blockSelect.addEventListener("change", function () {
        const blockId = this.value;
        resetMemberTabSelect(correspondingZoneSelect, "Choose a Zone");

        if (blockId) {
          // Fetch zones for the selected block
          fetch(`/get_zones/${blockId}`)
            .then((response) => response.json())
            .then((data) => {
              populateMemberTabSelect(correspondingZoneSelect, data, "Choose a Zone");
              // Update members table with block filter
              updateMembersTable(blockId);
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Error fetching zones. Please try again.");
            });
        } else {
          // If no block selected, reset the table to show all members
          location.reload();
        }
      });

      // Handle zone selection
      correspondingZoneSelect.addEventListener("change", function() {
        const zoneId = this.value;
        const blockId = blockSelect.value;

        if (blockId && zoneId) {
          // Update members table with both block and zone filters
          updateMembersTable(blockId, zoneId);
        } else if (blockId) {
          // If zone is deselected, filter by block only
          updateMembersTable(blockId);
        }
      });

      // Initially disable zone selects
      resetMemberTabSelect(correspondingZoneSelect, "Choose a Zone");
    });
  });
</script>
{% endblock %}
